import os
import logging
import asyncio  # <--- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç asyncio
from aiogram.types import Message
from aiogram.enums import ContentType
from aiogram import Bot
from dotenv import load_dotenv
import google.generativeai as genai
import numpy as np
from sklearn.metrics.pairwise import cosine_similarity
import aiofiles

load_dotenv()
BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")

genai.configure(api_key=GOOGLE_API_KEY)

# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –º–æ–¥–µ–ª–µ–π. Gemini 1.5 –º–æ–¥–µ–ª–∏ —Ö–æ—Ä–æ—à–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç–∏.
GENERATION_MODEL_NAME = "gemini-1.5-flash-latest"
EMBEDDING_MODEL_NAME = "models/text-embedding-004"
AUDIO_TRANSCRIPTION_MODEL_NAME = "gemini-1.5-flash-latest"  # –î–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏

DATA_DIR = "static/knowledge_files"  # –ü–∞–ø–∫–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –∑–Ω–∞–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
MAX_RAG_CHUNKS = 3
CHUNK_SIZE = 512
CHUNK_OVERLAP = 100

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥, –∫–æ—Ç–æ—Ä—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç, –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π RAG
RAG_LOADED = False

RAG_DATA = {
    "chunks": [],
    "embeddings": None,
    "file_source": []  # –•—Ä–∞–Ω–∏—Ç –∏–º—è —Ñ–∞–π–ª–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞
}
USER_CHAT_SESSIONS = {}  # –°–µ—Å—Å–∏–∏ —á–∞—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
if not logging.getLogger().hasHandlers():
    logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


def get_text_chunks(text: str, filename: str = "generic"):
    """–†–∞–∑–¥–µ–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —á–∞–Ω–∫–∏ —Å —É—á–µ—Ç–æ–º –≥—Ä–∞–Ω–∏—Ü –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π/–∞–±–∑–∞—Ü–µ–≤ –∏ –æ–≤–µ—Ä–ª–∞–ø–∞."""
    chunks = []
    start = 0
    text_len = len(text)
    while start < text_len:
        end = min(start + CHUNK_SIZE, text_len)
        # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫ –∏ –º—ã –º–æ–∂–µ–º –Ω–∞–π—Ç–∏ –ª—É—á—à–∏–π —Ä–∞–∑—Ä—ã–≤
        if end < text_len:
            # –ò—â–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ —Ç–æ—á–∫—É –¥–ª—è –±–æ–ª–µ–µ —á–∏—Å—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
            # –ò—â–µ–º –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [start + CHUNK_OVERLAP, end], —á—Ç–æ–±—ã –Ω–µ –æ–±—Ä–µ–∑–∞—Ç—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ
            # –∏ —á—Ç–æ–±—ã —Ä–∞–∑—Ä—ã–≤ –±—ã–ª –Ω–µ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–≤–µ—Ä–ª–∞–ø–∞.
            break_point = -1
            # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –±–æ–ª–µ–µ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–π –∑–æ–Ω–µ (–Ω–µ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ start)
            search_start_for_break = start + CHUNK_SIZE // 2

            # –ü–æ–∏—Å–∫ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫–∏
            temp_bp = text.rfind('\n', search_start_for_break, end)
            if temp_bp != -1:
                break_point = temp_bp + 1  # –í–∫–ª—é—á–∞–µ–º —Å–∞–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
            else:
                # –ï—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞, –∏—â–µ–º —Ç–æ—á–∫—É
                temp_bp = text.rfind('.', search_start_for_break, end)
                if temp_bp != -1:
                    break_point = temp_bp + 1  # –í–∫–ª—é—á–∞–µ–º —Ç–æ—á–∫—É

            # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ö–æ—Ä–æ—à–∏–π —Ä–∞–∑—Ä—ã–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if break_point != -1:
                end = break_point
            # –ï—Å–ª–∏ —Ö–æ—Ä–æ—à–∏–π —Ä–∞–∑—Ä—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ –º—ã –Ω–µ –≤ –∫–æ–Ω—Ü–µ —Ç–µ–∫—Å—Ç–∞,
            # –∏ end —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ –æ–±—Ä–µ–∑–∞–µ—Ç, –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞–π—Ç–∏ —Ä–∞–∑—Ä—ã–≤ –±–ª–∏–∂–µ –∫ start,
            # –Ω–æ –Ω–µ —Ä–∞–Ω—å—à–µ —á–µ–º start + CHUNK_OVERLAP, —á—Ç–æ–±—ã –∏–º–µ—Ç—å —Å–º—ã—Å–ª –¥–ª—è –æ–≤–µ—Ä–ª–∞–ø–∞.
            # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑—Ä—ã–≤, —Ä–µ–∂–µ–º –ø–æ CHUNK_SIZE.

        chunks.append(text[start:end])

        if end >= text_len:  # –î–æ—Å—Ç–∏–≥–ª–∏ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—Å—Ç–∞
            break

        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —á–∞–Ω–∫—É
        start = end - CHUNK_OVERLAP
        if start < 0:  # –≠—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å, –µ—Å–ª–∏ CHUNK_OVERLAP < CHUNK_SIZE
            start = 0  # –ó–∞—â–∏—Ç–∞

    logger.info(f"–†–∞–∑–¥–µ–ª–µ–Ω '{filename}' –Ω–∞ {len(chunks)} —á–∞–Ω–∫–æ–≤.")
    return chunks


async def embed_chunks(text_chunks: list[str]) -> np.ndarray | None:
    """–°–æ–∑–¥–∞—ë—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ —á–∞–Ω–∫–æ–≤ –±–∞—Ç—á–∞–º–∏."""
    if not text_chunks:
        return None
    try:
        all_embeddings = []
        # Gemini API –¥–ª—è text-embedding-004 —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –¥–æ 100 —Ç–µ–∫—Å—Ç–æ–≤ –Ω–∞ –∑–∞–ø—Ä–æ—Å
        batch_size = 100
        for i in range(0, len(text_chunks), batch_size):
            batch = text_chunks[i:i + batch_size]
            result = await genai.embed_content_async(
                model=EMBEDDING_MODEL_NAME,
                content=batch,  # –ü–µ—Ä–µ–¥–∞–µ–º –±–∞—Ç—á
                task_type="RETRIEVAL_DOCUMENT"
            )
            all_embeddings.extend(result['embedding'])

        if not all_embeddings:  # –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –Ω–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã
            return None
        return np.array(all_embeddings).reshape(len(text_chunks), -1)
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞: {e}")
        return None


async def update_rag_knowledge_base_from_folder(folder_path: str):
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ .txt –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–∏ –≤ RAG_DATA."""
    global RAG_LOADED  # –ú—ã –±—É–¥–µ–º –º–µ–Ω—è—Ç—å —ç—Ç–æ—Ç —Ñ–ª–∞–≥
    if not os.path.isdir(folder_path):
        logger.error(f"–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {folder_path}")
        return False

    any_file_processed_successfully = False
    for filename in os.listdir(folder_path):
        if filename.endswith(".txt"):
            filepath = os.path.join(folder_path, filename)
            # –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ –ø–∞–ø–∫–∏ –Ω–µ –æ—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–ª—è —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –±—ã–ª (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
            # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, clear_existing_for_file –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å True
            success = await update_rag_knowledge_base(filepath, clear_existing_for_file=False,
                                                      source_identifier=filename)
            if success:
                any_file_processed_successfully = True

    if any_file_processed_successfully:
        logger.info("‚úÖ –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∏–∑ –ø–∞–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.")
        RAG_LOADED = True  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —Ç.–∫. —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω
        return True
    else:
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ –æ–¥–∏–Ω —Ñ–∞–π–ª –∏–∑ –ø–∞–ø–∫–∏.")
        # RAG_LOADED –Ω–µ –º–µ–Ω—è–µ–º –Ω–∞ False, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –±—ã–ª True –æ—Ç –¥—Ä—É–≥–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫
        return False


async def update_rag_knowledge_base(
        filepath: str,
        clear_existing_for_file: bool = False,
        source_identifier: str = None
):
    """–î–æ–±–∞–≤–ª—è–µ—Ç (–∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç) –æ–¥–∏–Ω —Ñ–∞–π–ª –≤ RAG_DATA."""
    global RAG_DATA, RAG_LOADED
    source_identifier = source_identifier or os.path.basename(filepath)  # –ò–º—è —Ñ–∞–π–ª–∞ –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    if clear_existing_for_file:
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —á–∞–Ω–∫–∏ –∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        indices_to_keep = [i for i, src in enumerate(RAG_DATA["file_source"]) if src != source_identifier]

        RAG_DATA["chunks"] = [RAG_DATA["chunks"][i] for i in indices_to_keep]
        RAG_DATA["file_source"] = [RAG_DATA["file_source"][i] for i in indices_to_keep]
        if RAG_DATA["embeddings"] is not None and RAG_DATA["embeddings"].size > 0:
            if indices_to_keep:  # –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –∫–∞–∫–∏–µ-—Ç–æ —á–∞–Ω–∫–∏
                RAG_DATA["embeddings"] = RAG_DATA["embeddings"][indices_to_keep]
            else:  # –ï—Å–ª–∏ –≤—Å–µ —á–∞–Ω–∫–∏ –±—ã–ª–∏ –æ—Ç —ç—Ç–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏ –∏—Ö —É–¥–∞–ª–∏–ª–∏
                RAG_DATA["embeddings"] = None

        if not RAG_DATA["chunks"]:  # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ —á–∞–Ω–∫–æ–≤ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å
            RAG_DATA["embeddings"] = None  # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ —Ç–æ–∂–µ –ø—É—Å—Ç—ã
            # RAG_LOADED –∑–¥–µ—Å—å –Ω–µ –º–µ–Ω—è–µ–º –Ω–∞ False, —Ç.–∫. —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
        logger.info(f"–û—á–∏—â–µ–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ RAG –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞: {source_identifier}")

    try:
        async with aiofiles.open(filepath, "r", encoding="utf-8") as f:
            content = await f.read()
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ {filepath}: {e}")
        return False

    new_chunks = get_text_chunks(content, filename=source_identifier)
    if not new_chunks:
        logger.warning(f"–ò–∑ {filepath} –Ω–µ —Å–æ–∑–¥–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —á–∞–Ω–∫–∞ (—Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª).")
        # –ï—Å–ª–∏ —á–∞–Ω–∫–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã, –Ω–æ —Ñ–∞–π–ª –±—ã–ª –ø—Ä–æ—á–∏—Ç–∞–Ω, —ç—Ç–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—à–∏–±–∫–∞, –Ω–æ RAG –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—Å—è
        # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –Ω–æ–≤—ã—Ö —á–∞–Ω–∫–æ–≤ –±–∞–∑–∞ –æ—Å—Ç–∞–ª–∞—Å—å –ø—É—Å—Ç–æ–π, RAG_LOADED –¥–æ–ª–∂–µ–Ω –æ—Ç—Ä–∞–∂–∞—Ç—å —ç—Ç–æ.
        if not RAG_DATA["chunks"]:
            RAG_LOADED = False
        return True  # –°—á–∏—Ç–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é "—É—Å–ø–µ—à–Ω–æ–π" –≤ –ø–ª–∞–Ω–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞, —Ö–æ—Ç—å –∏ –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–∞–Ω–∫–æ–≤

    new_embeddings = await embed_chunks(new_chunks)
    if new_embeddings is None:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è —á–∞–Ω–∫–æ–≤ –∏–∑ {filepath}")
        return False

    RAG_DATA["chunks"].extend(new_chunks)
    RAG_DATA["file_source"].extend([source_identifier] * len(new_chunks))

    if RAG_DATA["embeddings"] is None or RAG_DATA["embeddings"].size == 0:
        RAG_DATA["embeddings"] = new_embeddings
    else:
        RAG_DATA["embeddings"] = np.vstack([RAG_DATA["embeddings"], new_embeddings])

    logger.info(
        f"‚úÖ –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∞ {len(new_chunks)} —á–∞–Ω–∫–∞–º–∏ –∏–∑ {filepath}. "
        f"–í—Å–µ–≥–æ —á–∞–Ω–∫–æ–≤: {len(RAG_DATA['chunks'])}"
    )
    RAG_LOADED = True  # –£—Å–ø–µ—à–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ RAG –∑–∞–≥—Ä—É–∂–µ–Ω
    return True


async def retrieve_relevant_chunks(query: str, top_n: int = MAX_RAG_CHUNKS) -> list[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ RAG_DATA –¥–æ top_n –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ –ø–æ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–π –±–ª–∏–∑–æ—Å—Ç–∏."""
    if not RAG_DATA["chunks"] or RAG_DATA["embeddings"] is None or RAG_DATA["embeddings"].size == 0:
        return []

    try:
        query_embedding_result = await genai.embed_content_async(
            model=EMBEDDING_MODEL_NAME,
            content=query,
            task_type="RETRIEVAL_QUERY"
        )
        query_embedding = np.array(query_embedding_result['embedding']).reshape(1, -1)

        similarities = cosine_similarity(query_embedding, RAG_DATA["embeddings"])[0]

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã N –ª—É—á—à–∏—Ö —á–∞–Ω–∫–æ–≤
        # argsort —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é, –ø–æ—ç—Ç–æ–º—É –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
        sorted_indices = np.argsort(similarities)[-top_n:][::-1]

        relevant_chunks = []
        for index in sorted_indices:
            if similarities[index] > 0.5:  # –ü–æ—Ä–æ–≥ –æ—Ç—Å–µ—á–µ–Ω–∏—è –ø–æ —Å—Ö–æ–∂–µ—Å—Ç–∏
                relevant_chunks.append(RAG_DATA["chunks"][index])
            # else:
            # –ï—Å–ª–∏ —Å–∞–º—ã–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∏–∑ top_n —É–∂–µ –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è,
            # —Ç–∞–∫ –∫–∞–∫ sorted_indices –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —É–±—ã–≤–∞–Ω–∏—é —Å—Ö–æ–∂–µ—Å—Ç–∏.
            # break
        # –û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ top_n=3, –∏ —Å—Ö–æ–∂–µ—Å—Ç–∏ [0.9, 0.4, 0.8], —Ç–æ break –ø–æ—Å–ª–µ 0.4 –Ω–µ –¥–∞—Å—Ç –Ω–∞–º 0.8.
        # –ü–æ—ç—Ç–æ–º—É –ª—É—á—à–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ top_n –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã.
        # argsort –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ [-top_n:] –¥–∞—Å—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ —É–±—ã–≤–∞–Ω–∏—é –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ö–æ–∂–µ—Å—Ç–∏,
        # –æ–Ω –¥–∞–µ—Ç –∏–Ω–¥–µ–∫—Å—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ë–´–õ–ò –ë–´ –Ω–∞ —ç—Ç–∏—Ö –º–µ—Å—Ç–∞—Ö –ø—Ä–∏ –ø–æ–ª–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ.
        # –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ø-N —Å –ø–æ—Ä–æ–≥–æ–º, –ª—É—á—à–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ö–æ–∂–µ—Å—Ç–∏, –∞ –ø–æ—Ç–æ–º –±—Ä–∞—Ç—å —Ç–æ–ø.

        # –ë–æ–ª–µ–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –≤–∑—è—Ç—å —Ç–æ–ø N —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å –ø–æ—Ä–æ–≥–æ–º:
        # 1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å—Ö–æ–∂–µ—Å—Ç–∏.
        # 2. –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–µ, —á—Ç–æ –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞.
        # 3. –ò–∑ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∑—è—Ç—å —Ç–æ–ø N.

        # –ò–ª–∏: –≤–∑—è—Ç—å —Ç–æ–ø N –ø–æ —Å—Ö–æ–∂–µ—Å—Ç–∏, –ø–æ—Ç–æ–º –∏–∑ –Ω–∏—Ö –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –ø–æ—Ä–æ–≥—É. (–ö–∞–∫ —Å–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å)

        logger.info(
            f"–ò–∑–≤–ª–µ—á–µ–Ω–æ {len(relevant_chunks)} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ –∏–∑ {len(sorted_indices)} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (top_n={top_n}, –ø–æ—Ä–æ–≥=0.5).")
        return relevant_chunks
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤: {e}")
        return []


async def get_chat_session(user_id: int) -> genai.ChatSession:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é —á–∞—Ç–∞ Gemini –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    if user_id not in USER_CHAT_SESSIONS:
        logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        model = genai.GenerativeModel(
            GENERATION_MODEL_NAME,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
            system_instruction=(
                "–¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. "
                "–ö–æ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ—Ç–≤–µ—Ç–∞. "
                "–ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –æ—Ç–≤–µ—á–∞–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–≤–æ–∏—Ö –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π."
            )
        )
        USER_CHAT_SESSIONS[user_id] = model.start_chat(history=[])
    return USER_CHAT_SESSIONS[user_id]


async def initialize_gemini_assistant():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RAG-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞: –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ .txt –∏–∑ DATA_DIR."""
    # RAG_LOADED –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω –≤–Ω—É—Ç—Ä–∏ update_rag_knowledge_base_from_folder
    logger.info("–ü–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π RAG –∏–∑ DATA_DIR...")
    success = await update_rag_knowledge_base_from_folder(DATA_DIR)
    if success:
        logger.info("üß† –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π RAG —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ DATA_DIR.")
    else:
        logger.warning(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –∑–Ω–∞–Ω–∏–π RAG –∏–∑ DATA_DIR (—Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞).")
    return success  # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω


async def process_message(message: Message, bot: Bot):
    global RAG_LOADED, RAG_DATA  # –î–æ—Å—Ç—É–ø –∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º

    user_id = message.from_user.id
    chat_id = message.chat.id
    user_query_text = None  # –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∏–∑ –∞—É–¥–∏–æ –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)

    # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏–π
    if message.content_type in [ContentType.VOICE, ContentType.AUDIO]:
        await bot.send_message(chat_id, "üé§ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à–µ –∞—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏–µ...")

        file_id_tg = message.voice.file_id if message.content_type == ContentType.VOICE else message.audio.file_id
        file_info_tg = await bot.get_file(file_id_tg)

        downloaded_file_io = await bot.download_file(file_info_tg.file_path)
        audio_data_bytes = downloaded_file_io.read()

        # –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞ –¥–ª—è upload_file
        temp_audio_dir = "static/temp_audio"
        os.makedirs(temp_audio_dir, exist_ok=True)
        # –ò–º—è —Ñ–∞–π–ª–∞ –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–∑ mime_type, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
        # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º ogg –∏–ª–∏ mp3, –∫–æ—Ç–æ—Ä—ã–µ Gemini –æ–±—ã—á–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç
        file_extension = ".ogg"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if message.audio and message.audio.mime_type:
            ext_candidate = message.audio.mime_type.split('/')[-1]
            if ext_candidate in ["ogg", "mp3", "wav", "flac", "opus", "m4a", "aac"]:
                file_extension = f".{ext_candidate}"

        temp_audio_path = os.path.join(temp_audio_dir, f"user_{user_id}_{file_id_tg}{file_extension}")

        async with aiofiles.open(temp_audio_path, "wb") as f:
            await f.write(audio_data_bytes)

        try:
            audio_transcription_model = genai.GenerativeModel(AUDIO_TRANSCRIPTION_MODEL_NAME)
            logger.info(f"–ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞ {temp_audio_path} –≤ Gemini –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏...")

            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ Gemini
            audio_file_resource = genai.upload_file(path=temp_audio_path)
            logger.info(f"–ê—É–¥–∏–æ—Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: {audio_file_resource.name}. –û–∂–∏–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏...")

            # –û–∂–∏–¥–∞–µ–º, –ø–æ–∫–∞ Gemini –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–∞–π–ª
            while audio_file_resource.state.name == "PROCESSING":
                await asyncio.sleep(2)  # –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                audio_file_resource = genai.get_file(name=audio_file_resource.name)  # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ñ–∞–π–ª–∞

            if audio_file_resource.state.name == "FAILED":
                raise Exception(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞ –≤ Gemini –Ω–µ —É–¥–∞–ª–∞—Å—å: {audio_file_resource.state.name}")

            logger.info(f"–ê—É–¥–∏–æ—Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω Gemini: {audio_file_resource.name}")

            # –ó–∞–ø—Ä–æ—Å –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
            response = await audio_transcription_model.generate_content_async([
                audio_file_resource,  # –ü–µ—Ä–µ–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å —Ñ–∞–π–ª–∞
                "Transcribe this audio to text in Russian."  # –ü—Ä–æ–º–ø—Ç –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
            ])
            transcription = response.text
            user_query_text = transcription  # <--- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

            await bot.send_message(chat_id, f"üé§ –í–∞—à–µ –∞—É–¥–∏–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞–Ω–æ:\n{user_query_text}")

            # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –∏–∑ Gemini –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
            # try:
            #     await genai.delete_file_async(audio_file_resource.name)
            #     logger.info(f"–£–¥–∞–ª–µ–Ω —Ñ–∞–π–ª –∏–∑ Gemini —Ö—Ä–∞–Ω–∏–ª–∏—â–∞: {audio_file_resource.name}")
            # except Exception as e_del_gemini:
            #     logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –∏–∑ Gemini —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ {audio_file_resource.name}: {e_del_gemini}")

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ: {e}")
            await bot.send_message(chat_id, f"üö´ –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à–µ –∞—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏–µ: {str(e)}")
            return  # –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∞—É–¥–∏–æ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
        finally:
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –∞—É–¥–∏–æ—Ñ–∞–π–ª
            if os.path.exists(temp_audio_path):
                try:
                    os.remove(temp_audio_path)
                except Exception as e_rem:
                    logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ—Ñ–∞–π–ª {temp_audio_path}: {e_rem}")

        # –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, user_query_text —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏ –∫–æ–¥ –ø–æ–π–¥–µ—Ç –¥–∞–ª—å—à–µ

    # 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (.txt —Ñ–∞–π–ª–æ–≤ –¥–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π)
    elif message.content_type == ContentType.DOCUMENT:
        if message.document.mime_type == "text/plain":
            doc = message.document
            original_file_name = doc.file_name or f"user_upload_{doc.file_unique_id}.txt"

            temp_docs_dir = "static/temp_docs"  # –ü–∞–ø–∫–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            os.makedirs(temp_docs_dir, exist_ok=True)
            # –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
            temp_file_path = os.path.join(temp_docs_dir, f"user_{user_id}_{doc.file_unique_id}_{original_file_name}")

            try:
                await bot.send_message(chat_id, f"üì• –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à –¥–æ–∫—É–º–µ–Ω—Ç: {original_file_name}...")
                file_info_tg = await bot.get_file(doc.file_id)
                await bot.download_file(file_info_tg.file_path, destination=temp_file_path)

                # –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ –∑–∞–≥—Ä—É–∑–∫—É, –æ—á–∏—â–∞–µ–º –µ–≥–æ —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ RAG
                if await update_rag_knowledge_base(
                        temp_file_path,
                        clear_existing_for_file=True,
                        source_identifier=original_file_name  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
                ):
                    await bot.send_message(chat_id,
                                           f"‚úÖ –î–æ–∫—É–º–µ–Ω—Ç '{original_file_name}' —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π!")
                else:
                    await bot.send_message(chat_id,
                                           f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç '{original_file_name}' –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ '{original_file_name}': {e}")
                await bot.send_message(chat_id, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞.")
            finally:
                if os.path.exists(temp_file_path):
                    try:
                        os.remove(temp_file_path)
                    except Exception as e_rem:
                        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞ {temp_file_path}: {e_rem}")
            return  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ - —ç—Ç–æ –∫–æ–Ω–µ—á–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        else:
            await bot.send_message(chat_id,
                                   "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª (.txt) –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.")
            return

    # 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    elif message.text:
        user_query_text = message.text

    # 4. –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∏–∑ –∞—É–¥–∏–æ –∏–ª–∏ –æ–±—ã—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è), –∑–∞–ø—É—Å–∫–∞–µ–º RAG –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–∞
    if user_query_text:
        # –õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∏–∑ DATA_DIR, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ –±—ã–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
        # (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –±–æ—Ç–∞, –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –∫–æ–º–∞–Ω–¥ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–æ–∫ —Ñ–∞–π–ª–æ–≤)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á–∞–Ω–∫–∏ –≤ RAG_DATA. –ï—Å–ª–∏ –Ω–µ—Ç, –∏ RAG_LOADED —Ç–æ–∂–µ False, —Ç–æ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å.
        if not RAG_DATA["chunks"] and not RAG_LOADED:
            logger.info("–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π RAG –ø—É—Å—Ç–∞. –ü–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø–∞–ø–∫–∏ DATA_DIR...")
            await initialize_gemini_assistant()  # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–∏—Ç RAG_LOADED, –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ

        await bot.send_chat_action(chat_id, "typing")  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±–æ—Ç "–ø–µ—á–∞—Ç–∞–µ—Ç"
        think_msg = await bot.send_message(chat_id, "‚è≥ –î—É–º–∞—é –Ω–∞–¥ –≤–∞—à–∏–º –∑–∞–ø—Ä–æ—Å–æ–º...")

        chat_session = await get_chat_session(user_id)

        relevant_chunks = []
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞–Ω–∫–∏, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ RAG_DATA —Å–æ–¥–µ—Ä–∂–∏—Ç —á–∞–Ω–∫–∏
        # RAG_LOADED –º–æ–∂–µ—Ç –±—ã—Ç—å True, –Ω–æ —á–∞–Ω–∫–æ–≤ –Ω–µ—Ç, –µ—Å–ª–∏ –≤—Å–µ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å.
        if RAG_DATA["chunks"]:
            relevant_chunks = await retrieve_relevant_chunks(user_query_text)

        if relevant_chunks:
            context_str = "\n\n---\n\n".join(relevant_chunks)
            prompt_for_gemini = (
                """–¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ–Ω—è—Ç—å, –∫–∞–∫ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏–∑–≤–ª–µ—á—å —à–∞–≥–∏ –∏–∑ —Å—Ü–µ–Ω–∞—Ä–∏—è –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –∏—Ö –≤ –≤–∏–¥–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.

### –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ—Ç–≤–µ—Ç–∞–º:

1.  **–Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞:** –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ.
2.  **–ü—Ä–æ–ø—É—Å–∫ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —à–∞–≥–∞:** –ù–ï –≤–∫–ª—é—á–∞–π –≤ –æ—Ç–≤–µ—Ç —à–∞–≥, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –æ—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞. –û–±—ã—á–Ω–æ –æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–æ —Å–ª–æ–≤ "–ö–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –æ–∫–Ω–æ...". –¢–≤–æ—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å–æ –í–¢–û–†–û–ì–û –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è, –æ–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏.
3.  **–û–±–æ–±—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–ö–†–ê–ô–ù–ï –í–ê–ñ–ù–û):**
    *   –ö–æ–≥–¥–∞ –∏–∑–≤–ª–µ–∫–∞–µ—à—å —à–∞–≥–∏, –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –ö–û–ù–ö–†–ï–¢–ù–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏—è.
    *   –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ, —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —à–∞–≥ —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–Ω—è–ª, –ö–ê–ö–û–ï –î–ï–ô–°–¢–í–ò–ï –µ–º—É –Ω—É–∂–Ω–æ —Å–æ–≤–µ—Ä—à–∏—Ç—å –∏ –ì–î–ï, –Ω–æ —Å–æ –°–í–û–ò–ú–ò –¥–∞–Ω–Ω—ã–º–∏.
    *   **–ü—Ä–∏–º–µ—Ä—ã –æ–±–æ–±—â–µ–Ω–∏—è:**
        *   –ï—Å–ª–∏ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏: `–ò –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∏–º–µ–Ω–µ–º '–í–∏–¥–û–ø–µ—Ä–∞—Ü–∏–∏' —è –≤—ã–±–∏—Ä–∞—é —Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ "–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –∞–≤–∞–Ω—Å–æ–≤ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º"`
            –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `–ò–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∏–º–µ–Ω–µ–º '–í–∏–¥–û–ø–µ—Ä–∞—Ü–∏–∏' –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –∞–≤–∞–Ω—Å–æ–≤ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º", –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤—ã–±—Ä–∞—Ç—å —Å–≤–æ–µ).` –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ `–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ '–í–∏–¥–û–ø–µ—Ä–∞—Ü–∏–∏'.`
        *   –ï—Å–ª–∏ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏: `–ò –≤ –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '–ù–æ–º–µ—Ä–°—á–µ—Ç–∞' —è –≤–≤–æ–∂—É —Ç–µ–∫—Å—Ç "2"`
            –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `–í –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '–ù–æ–º–µ—Ä–°—á–µ—Ç–∞' –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –Ω–æ–º–µ—Ä —Å—á–µ—Ç–∞.`
        *   –ï—Å–ª–∏ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏: `–ò –≤ –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '–î–∞—Ç–∞' —è –≤–≤–æ–∂—É —Ç–µ–∫—Å—Ç "23.05.2025 12:12:34"`
            –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `–í –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '–î–∞—Ç–∞' –≤–≤–µ–¥–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.`
        *   –ï—Å–ª–∏ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏: `–ò –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∏–º–µ–Ω–µ–º '–ü–æ–ª—É—á–∞—Ç–µ–ª—å' —è –≤—ã–±–∏—Ä–∞—é —Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ "–ê–∫–º–æ–ª–∏–Ω—Å–∫–∏–π –æ–±–ª–∞—Å—Ç–Ω–æ–π —Ñ–∏–ª–∏–∞–ª –∞–∫—Ü–∏–æ–Ω–µ—Ä–Ω–æ–≥–æ –æ–±—â–µ—Å—Ç–≤–∞ \"–ö–∞–∑–ø–æ—á—Ç–∞\""`
            –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `–ò–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∏–º–µ–Ω–µ–º '–ü–æ–ª—É—á–∞—Ç–µ–ª—å' –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è.`
    *   **–¶–µ–ª—å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é, –∞ –Ω–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ª—è (`'–í–∏–¥–û–ø–µ—Ä–∞—Ü–∏–∏'`, `'–ù–æ–º–µ—Ä–°—á–µ—Ç–∞'`) –Ω–∞–∑—ã–≤–∞—Ç—å –Ω—É–∂–Ω–æ, –∞ –≤–æ—Ç –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ ‚Äî –Ω–µ—Ç.

4.  **–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ª—è (–ö–†–ê–ô–ù–ï –í–ê–ñ–ù–û):**
    *   –ï—Å–ª–∏ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —à–∞–≥, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ª—è –≤–≤–æ–¥–∞ –∏–ª–∏ –≤—ã–±–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `–ò —è –Ω–∞–∂–∏–º–∞—é –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞ —É –ø–æ–ª—è —Å –∏–º–µ–Ω–µ–º '[–ò–ú–Ø_–ü–û–õ–Ø]'`), –∏ **—Å—Ä–∞–∑—É –∑–∞ –Ω–∏–º** —Å–ª–µ–¥—É–µ—Ç —à–∞–≥ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –≤—ã–±–æ—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏—è –≤ **—ç—Ç–æ –∂–µ —Å–∞–º–æ–µ –ø–æ–ª–µ** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `–ò –≤ –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '[–ò–ú–Ø_–ü–û–õ–Ø]' —è –≤–≤–æ–∂—É —Ç–µ–∫—Å—Ç "[–ó–ù–ê–ß–ï–ù–ò–ï]"` –∏–ª–∏ `–ò –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∏–º–µ–Ω–µ–º '[–ò–ú–Ø_–ü–û–õ–Ø]' —è –≤—ã–±–∏—Ä–∞—é —Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ "[–ó–ù–ê–ß–ï–ù–ò–ï]"`):
        *   **–ù–ï –≤–∫–ª—é—á–∞–π** –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —à–∞–≥ –æ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —à–∞–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏).
        *   –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ, –ø—Ä–µ–¥—Å—Ç–∞–≤—å —ç—Ç–æ –∫–∞–∫ **–µ–¥–∏–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ** –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é –ø–æ–ª—è, –æ–±–æ–±—â–µ–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—Å–Ω–æ –ø—É–Ω–∫—Ç—É 3.
    *   **–ü—Ä–∏–º–µ—Ä:**
        *   –ï—Å–ª–∏ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏:
            `–ò —è –Ω–∞–∂–∏–º–∞—é –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞ —É –ø–æ–ª—è —Å –∏–º–µ–Ω–µ–º '–î–∞—Ç–∞'`
            `–ò –≤ –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '–î–∞—Ç–∞' —è –≤–≤–æ–∂—É —Ç–µ–∫—Å—Ç "23.05.2025 12:12:34"`
        *   –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `–í –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '–î–∞—Ç–∞' –≤–≤–µ–¥–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.` (—Ç–æ –µ—Å—Ç—å, —à–∞–≥ "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞..." –æ–ø—É—Å–∫–∞–µ—Ç—Å—è).

5.  **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:** –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π —à–∞–≥–∏ –≤ –≤–∏–¥–µ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ò –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞. –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ —Å–µ–±–µ '!!' –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ –∏ '!!' –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–µ—Ç–∫–∏–º –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º.
6.  **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:** –ï—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á–µ—Ç–∫–æ —É–∫–∞–∂–∏, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
7.  **–£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:** –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—è—Å–µ–Ω, –ø–æ–ø—Ä–æ—Å–∏ –µ–≥–æ —É—Ç–æ—á–Ω–∏—Ç—å.
8.  **–¶–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ):** –ï—Å–ª–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—Ö–æ—Ç—è –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —ç—Ç–æ —à–∞–≥–∏), —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∫—Ä–∞—Ç–∫–æ. (–≠—Ç–æ—Ç –ø—É–Ω–∫—Ç –º–µ–Ω–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –¥–ª—è –≤–∞—à–µ–π –∑–∞–¥–∞—á–∏, –Ω–æ –æ—Å—Ç–∞–≤–ª—é –µ–≥–æ –∫–∞–∫ —Ö–æ—Ä–æ—à—É—é –ø—Ä–∞–∫—Ç–∏–∫—É).

### –ü—Ä–∏–º–µ—Ä —Ç–æ–≥–æ, –∫–∞–∫ –ù–ï –ù–ê–î–û –æ—Ç–≤–µ—á–∞—Ç—å (—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ò —Å –ª–∏—à–Ω–∏–º —à–∞–≥–æ–º):

–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
1. –ò–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∏–º–µ–Ω–µ–º '–í–∏–¥–û–ø–µ—Ä–∞—Ü–∏–∏' —è –≤—ã–±–∏—Ä–∞—é —Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ "–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –∞–≤–∞–Ω—Å–æ–≤ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º"
2. –ò –≤ –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '–ù–æ–º–µ—Ä–°—á–µ—Ç–∞' —è –≤–≤–æ–∂—É —Ç–µ–∫—Å—Ç "2"
3. –ò —è –Ω–∞–∂–∏–º–∞—é –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞ —É –ø–æ–ª—è —Å –∏–º–µ–Ω–µ–º '–î–∞—Ç–∞'  <-- –≠–¢–û–¢ –®–ê–ì –õ–ò–®–ù–ò–ô –í –ò–ù–°–¢–†–£–ö–¶–ò–ò
4. –ò –≤ –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '–î–∞—Ç–∞' —è –≤–≤–æ–∂—É —Ç–µ–∫—Å—Ç "23.05.2025 12:12:34"
...

### –ü—Ä–∏–º–µ—Ä —Ç–æ–≥–æ, –ö–ê–ö –ù–ê–î–û –æ—Ç–≤–µ—á–∞—Ç—å (–æ–±–æ–±—â–µ–Ω–Ω–æ –∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö —à–∞–≥–æ–≤ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏):

–ü–†–ê–í–ò–õ–¨–ù–û (–Ω–∞ –≤–æ–ø—Ä–æ—Å "–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤?"):
!! –ß—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤, —Å–ª–µ–¥—É–π—Ç–µ —ç—Ç–∏–º —à–∞–≥–∞–º:
1.  –ò–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∏–º–µ–Ω–µ–º '–í–∏–¥–û–ø–µ—Ä–∞—Ü–∏–∏' –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –≤–∏–¥ –æ–ø–µ—Ä–∞—Ü–∏–∏.
 2.  –í –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '–ù–æ–º–µ—Ä–°—á–µ—Ç–∞' –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—á–µ—Ç–∞.
 3.  –í –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '–î–∞—Ç–∞' –≤–≤–µ–¥–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.
 4.  –í –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º '–î–∞—Ç–∞–û–ø–ª–∞—Ç—ã' –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –æ–ø–ª–∞—Ç—ã.
 5.  –ò–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∏–º–µ–Ω–µ–º '–®–∞–±–ª–æ–Ω' –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω.
 6.  –ò–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∏–º–µ–Ω–µ–º '–°—Ç–∞—Ç—å—è–†–∞—Å—Ö–æ–¥–æ–≤' –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é —Ä–∞—Å—Ö–æ–¥–æ–≤.
 7.  –ò–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∏–º–µ–Ω–µ–º '–°—á–µ—Ç–£—á—Ä–µ–∂–¥–µ–Ω–∏—è' –≤—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç —É—á—Ä–µ–∂–¥–µ–Ω–∏—è.
 8.  –ò–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∏–º–µ–Ω–µ–º '–ü–æ–ª—É—á–∞—Ç–µ–ª—å' –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è. !!"""
                f"–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô:\n{context_str}\n\n"
                f"–í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {user_query_text}"
            )
            logger.info(
                f"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å {len(relevant_chunks)} —á–∞–Ω–∫(–∞–º–∏) –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.")
        else:
            prompt_for_gemini = user_query_text  # –ï—Å–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            if RAG_DATA["chunks"]:  # –ï—Å–ª–∏ —á–∞–Ω–∫–∏ –≤ –±–∞–∑–µ –µ—Å—Ç—å, –Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –Ω–µ –Ω–∞—à–ª–æ—Å—å
                logger.info(
                    f"–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞–Ω–∫–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–∞–º –∑–∞–ø—Ä–æ—Å.")
            else:  # –ï—Å–ª–∏ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—É—Å—Ç–∞
                logger.info(f"–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π RAG –ø—É—Å—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}.")

        try:
            response = await chat_session.send_message_async(prompt_for_gemini)
            await bot.edit_message_text(  # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–î—É–º–∞—é..." –Ω–∞ –æ—Ç–≤–µ—Ç
                chat_id=chat_id,
                text=response.text,
                message_id=think_msg.message_id
            )
            logger.info(f"–û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}.")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Gemini API –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {e}")
            error_message_text = "üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞."
            # –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Gemini (–Ω–∞–ø—Ä–∏–º–µ—Ä, safety settings)
            if hasattr(e, 'args') and e.args:
                err_content_str = str(e.args[0]).lower()
                if "safety" in err_content_str or "blocked" in err_content_str:
                    error_message_text = "‚ö†Ô∏è –í–∞—à –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª–∏—Ç–∏–∫–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å."
                elif "candidate" in err_content_str and "finish_reason: SAFETY" in str(
                        e):  # –ë–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ –¥–ª—è Gemini
                    error_message_text = "‚ö†Ô∏è –û—Ç–≤–µ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∏–∑-–∑–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Safety)."

            await bot.edit_message_text(chat_id=chat_id, text=error_message_text, message_id=think_msg.message_id)

            # –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞, –µ—Å–ª–∏ –æ–Ω–æ –≤—ã–∑–≤–∞–ª–æ –æ—à–∏–±–∫—É,
            # —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å "–∑–∞—Å—Ç—Ä–µ–≤–∞–Ω–∏—è" —Å–µ—Å—Å–∏–∏ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–Ω–æ–º –ø—Ä–æ–º–ø—Ç–µ.
            if chat_session.history:
                last_entry = chat_session.history[-1]
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —ç—Ç–æ –Ω–∞—à –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if last_entry.role == "user" and last_entry.parts and last_entry.parts[0].text == prompt_for_gemini:
                    logger.warning("–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ Gemini –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.")
                    chat_session.history.pop()
        return

    # –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ –∏–∑ —É—Å–ª–æ–≤–∏–π –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç–∏–∫–µ—Ä, —Ñ–æ—Ç–æ –∏ —Ç.–¥.)
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥ –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ–º–∞–Ω–¥–∞
    if message.text and message.text.startswith('/'):  # –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã –∫–∞–∫ "–Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø"
        pass
    elif not user_query_text:  # –ï—Å–ª–∏ user_query_text –Ω–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—Ç.–µ. —ç—Ç–æ –Ω–µ —Ç–µ–∫—Å—Ç, –∞—É–¥–∏–æ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç)
        logger.info(
            f"–ü–æ–ª—É—á–µ–Ω –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ—Ç {user_id}: {message.content_type}. –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–æ.")
        # await bot.send_message(chat_id, "–Ø —É–º–µ—é —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–µ–∫—Å—Ç–æ–º, –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∏ .txt —Ñ–∞–π–ª–∞–º–∏ –¥–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.")

# –ù–µ –∑–∞–±—É–¥—å—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –≤ –≤–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª (–≥–¥–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è Dispatcher –∏ Bot) —Ö–µ–Ω–¥–ª–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π:
# from your_module import process_message # –ó–∞–º–µ–Ω–∏—Ç–µ your_module –Ω–∞ –∏–º—è –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
# ...
# dp.message.register(process_message, F.content_type.in_({ContentType.TEXT, ContentType.VOICE, ContentType.AUDIO, ContentType.DOCUMENT}))
# ...
# –¢–∞–∫–∂–µ, –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã /start, /clear_rag –∏ —Ç.–¥., –¥–ª—è –Ω–∏—Ö –Ω—É–∂–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã.
# –ù–∞–ø—Ä–∏–º–µ—Ä, /start –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å initialize_gemini_assistant().